<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <button id="enable-notifications" style="display: none;">Enable notifications</button>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCLrqb9JU3AsNj5-IbQRPfMVisLU9Cw6b0",
    authDomain: "test-noti-26fe8.firebaseapp.com",
    projectId: "test-noti-26fe8",
    storageBucket: "test-noti-26fe8.firebasestorage.app",
    messagingSenderId: "324451601078",
    appId: "1:324451601078:web:2a89bfdf05279a313cb417",
  };

  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  const vapidKey = "BEpbjRiBXfFGTBKeSPR74pq9muipfIgLP9vcGqrRHcyP2LSvBLQqNauFTJ7wEjR6hK0ZfLjY-k4F7FPeGeDOCB8";
  const btn = document.getElementById("enable-notifications");

  const getCSRF = () => {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : null;
  };

  const saveToken = (token) => {
    fetch("/teacher/save-fcm-token/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRF(),
      },
      credentials: "include",
      body: JSON.stringify({ token }),
    })
      .then((res) => res.json())
      .then((data) => console.log("Token saved:", data))
      .catch((err) => console.error("Save failed:", err));
  };

  const requestAndSendToken = (registration) => {
    getToken(messaging, {
      vapidKey,
      serviceWorkerRegistration: registration,
    })
      .then((token) => {
        if (token) {
          console.log("FCM Token:", token);
          saveToken(token);
        }
      })
      .catch((err) => console.error("Token error:", err));
  };

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/firebase-messaging-sw.js").then((reg) => {
      console.log("Service Worker registered");

      if (Notification.permission === "granted") {
        requestAndSendToken(reg);
      } else {
        btn.style.display = "inline-block";
        btn.addEventListener("click", () => {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") requestAndSendToken(reg);
          });
        });
      }
    });
  }

  onMessage(messaging, (payload) => {
  console.log("Foreground message:", payload);

  if (Notification.permission === "granted") {
    new Notification(payload.data.title, {
      body: payload.data.body,
      icon: payload.data.icon,
      image: payload.data.image
    });
  }
});

  
</script>


</body>

</html>